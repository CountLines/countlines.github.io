<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Clipboard and File Lines Counter</title>
    <style>
        body {
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            font-family: Arial, sans-serif;
            overflow: hidden;
            margin: 0;
            font-size: 18px;
        }
        .container {
            text-align: center;
        }
        button {
            padding: 10px 20px;
            font-size: 18px;
            margin: 5px;
        }
        #lineCount, #timeSpent {
            margin-top: 20px;
            font-weight: bold;
            font-size: 20px;
        }
        #fileName {
            margin-top: 5px;
            font-size: 18px;
            font-weight: bold;
        }
    </style>
</head>
<body>

<div class="container">
    <div>Lines loaded: <span id="lineCount">0</span></div>
    <div>Time spent: <span id="timeSpent">0.0</span> sec</div>
    <div>File name: <span id="fileName">None</span></div>
    <button id="uploadClipboardButton">Upload from Clipboard</button>
    <button id="uploadFileButton">Upload from File</button>
    <input type="file" id="fileInput" style="display: none;">
</div>

<script>
    let timerInterval;
    let startTime;
    
    function formatNumber(num) {
        return num.toString().replace(/\B(?=(\d{3})+(?!\d))/g, " ");
    }

    function toggleUIBlock(isBlocked) {
        const buttons = document.querySelectorAll('button');
        buttons.forEach(button => button.disabled = isBlocked);
        document.body.style.cursor = isBlocked ? 'wait' : 'default';
    }

    function startTimer() {
        startTime = performance.now();
        document.getElementById('timeSpent').innerText = '0.0';
        timerInterval = setInterval(() => {
            const currentTime = performance.now();
            const timeSpent = ((currentTime - startTime) / 1000).toFixed(1);
            document.getElementById('timeSpent').innerText = timeSpent;
        }, 100);
    }

    function stopTimer() {
        clearInterval(timerInterval);
    }
    async function countLinesFromFile(file) {
        const CHUNK_SIZE = 1024 * 1024 * 32; // размер чанка 64 МБ
        const numChunks = Math.ceil(file.size / CHUNK_SIZE);
        let totalLines = 0;
        let chunkIndex = 0; // индекс текущего  чанка

        const workers = []; // массив воркеров
        const results = []; // массив промисов для результатов обработки

        function createWorker(workerIndex) {
            return new Promise((resolve) => {
                const worker = new Worker('worker.js');
                
                function handleMessage(e) {
                    totalLines += e.data.linesCount;
                    if (chunkIndex < numChunks) {
                        // если остались чанки для обработки, отправляем следующий
                        const nextChunk = file.slice(chunkIndex * CHUNK_SIZE, (chunkIndex + 1) * CHUNK_SIZE);
                        chunkIndex++;
                        worker.postMessage({ chunk: nextChunk, index: chunkIndex });
                    } else {
                        // все чанки обработаны, завершаем воркер
                        worker.terminate();
                        resolve();
                    }
                }

                worker.onmessage = handleMessage;

                // отправляем первый чанк этому воркеру
                const firstChunk = file.slice(chunkIndex * CHUNK_SIZE, (chunkIndex + 1) * CHUNK_SIZE);
                chunkIndex++;
                worker.postMessage({ chunk: firstChunk, index: chunkIndex });
            });
        }

        // создаем воркеров по количеству ядер процессора
        for (let i = 0; i < navigator.hardwareConcurrency * 2; i++) {
            if (chunkIndex < numChunks) {
                results.push(createWorker(i));
            }
        }

        // ожидаем завершения всех воркеров
        await Promise.all(results);

        return totalLines;
    }

    document.getElementById('uploadClipboardButton').addEventListener('click', async () => {
        try {
            toggleUIBlock(true);
            document.getElementById('lineCount').innerText = 'loading...';
            document.getElementById('fileName').innerText = 'None';
            startTimer();

            const text = await navigator.clipboard.readText();
            if (!text) {
                alert('Clipboard is empty or does not contain text!');
                document.getElementById('lineCount').innerText = '0';
                stopTimer();
                return;
            }

            const lineCount = (text.match(/\r\n|\r|\n/g) || []).length + 1;

            stopTimer();

            document.getElementById('lineCount').innerText = formatNumber(lineCount);
        } catch (err) {
            console.error('Failed to read clipboard contents: ', err);
            alert('Error reading clipboard contents.');
            document.getElementById('lineCount').innerText = '0';
            stopTimer();
        } finally {
            toggleUIBlock(false);
        }
    });

    document.getElementById('uploadFileButton').addEventListener('click', () => {
        document.getElementById('fileInput').value = '';
        document.getElementById('fileInput').click();
    });

    document.getElementById('fileInput').addEventListener('change', async (event) => {
        const file = event.target.files[0];
        if (!file) {
            document.getElementById('lineCount').innerText = '0';
            document.getElementById('timeSpent').innerText = '0.0';
            document.getElementById('fileName').innerText = 'None';
            toggleUIBlock(false);
            return;
        }

        try {
            toggleUIBlock(true);
            document.getElementById('lineCount').innerText = `loading using ${navigator.hardwareConcurrency * 2} workers... `;
            document.getElementById('fileName').innerText = file.name;
            startTimer();

            const lineCount = await countLinesFromFile(file);

            stopTimer();

            document.getElementById('lineCount').innerText = formatNumber(lineCount);
        } catch (err) {
            console.error('Failed to read file: ', err);
            alert('Error reading the file.');
            document.getElementById('lineCount').innerText = '0';
            stopTimer();
        } finally {
            toggleUIBlock(false);
        }
    });
</script>

</body>
</html>
